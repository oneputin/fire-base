<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="fire-base.html">
<!--
`fire-query` is the generic firebase-data-query element as well 
- for pull-queries (get) , if  as 
- for push-queries (save)  
The actions are triggered by changes 
@element fire-query
@demo demo/cloud-query.html
-->

<dom-module id="fire-query">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>
    
    <fire-base app="{{app}}" fb="{{fb}}" ></fire-base>

  </template>

  <script>

    Polymer({
      is: 'fire-query',
      properties: {
        /**
         * Key of requested firebase-app
         * @type {String}
         */
        app: {  
          type: String
        },
        /**
         * Firebase app
         * @type {Object}
         */
        fb: {
          type: Object
        },

        path:{
          type: String
        },

        key: {
          type: String
        },  

        // query(order)Item
        item: {         
          type: String   
        },
        
        // queryValue (of orderItem)
        itemvalue:{     
          type: String,
          value: "_all_"  
        },

        // operator(relating queryItem and queryValue)
        operator: {      
          type: String
        },

        data: {
          type: Object,
          notify: true
        },

        setdata: {
          type: Object
        }, 
        
        toast : {
          type: String,
          notify: true
        }
      },

      observers: [
        'fbPathQuery(fb, path, item)',
        'fbItemQuery(fb, path, item, itemvalue)', 
        'fbPathSave(fb, setdata, path, key)'       
      ],

      ready: function() { // console.log("firequery-ready");
      },

      /* */  
      fbPathQuery: function(fb, path, item) { 

        if (!item || (item == "_all_")) {  console.log("fbPathQuery, path=", path, item); 

          // var that = this; // ALTMODISCH (use bind() instead?)
          fb.database().ref(path).once('value').then(function(snapshot) { 
            console.log("snapped pathmode", snapshot.val());
            this.data = snapshot.val();
          }.bind(this))
        }
      },

      /* */
      fbItemQuery: function(fb, path, item, value) {  

        if (!item || (item == "_all_")) return;  

        var op  = this.operator, // optional operator 
            ops = ["<", ">", "!"];

        var ref = fb.database()
                    .ref(path);

        if (item.indexOf("*") >= 0) { // console.log("check existence of multiple "wildcarded" properties"); 



        } else if (value && (value != '_all_') ) {

          ref = ref.orderByChild(item);
          
          var wildcardpos = value.indexOf("*"); // 
         
          if (ops.indexOf(value.substring(0,1)) >= 0) {
            op    = value.substring(0,1);
            value = value.substring(1); 
          }   

          if (wildcardpos > 0) { 

            var wildcard = value.substring(0, wildcardpos);   console.log("wildcardQuery: ", "path="+path, "var="+ item, "wild=" + wildcard); 

            ref = ref.startAt(wildcard).endAt(wildcard+"\uf8ff");

          } else {

            var vnum = parseFloat(value);  
            if (!isNaN(vnum)) value = vnum;
            
            if (!op) {            console.log("strictValueQuery: ", "path="+path, "var="+ item, "val=" + value); 
                ref = ref.equalTo(value);
              // if (isNaN(vnum)) ref = ref.equalTo(value);
              // else             ref = ref.equalTo(vnum);
            } else if (op=="<") {  console.log("rangeQuery < : ", "path="+path, "var="+ item, "val=" + value); 
                ref = ref.startAt(0).endAt(value);
            } else if (op==">") {  console.log("rangeQuery > : ", "path="+path, "var="+ item, "val=" + value); 
                ref = ref.startAt(value);
            }   

          } // console.log("fbItemQuery prepared: ", ref); 

        } else { // DEFAULT QUERY if no specific value queried 

            ref = ref.orderByChild(item);
            ref = ref.startAt(0).endAt("z");    // numeric + string values
            // ref = ref.startAt("A").endAt("z");     // all string values  
            // ref = ref.startAt("a").endAt("z");  // lowercase string values only  
            // ref = ref.startAt("A").endAt("Z");  // uppercase string values only  
        }

        // OPTIONAL : return 'count' records(objects) only 
        var count = this.count; 
        if (count > 0) { 
          ref = ref.limitToFirst(count); console.log("query max. "+count+" documents only: ", ref);
        } 

        var that = this; // ALTMODISCH (use bind() instead?)

        // APPLY the query 
        ref.once('value')
           .then(function(snapshot) {  // console.log("snapshot-value", snapshot.val());
              that.data = snapshot.val();
           })
           .catch( function (errorObject) {
              console.log("FBserver: The read failed with " + errorObject.code);  
           });
      },

      /* */ 
      fbPathSave: function(fb, dbData, dbPath, dbKey) { 

        // save the doc-reference to database
        if (!Object.keys(dbData).length) { console.log("Missing data to submit")
          return; 
        } //console.log("triggered to save at path:", dbPath, dbData);
        
        // 1. 
        if (!fb.database().ref().child(dbPath)) { // target-path-node must exist to enable key-generator
          fb.database().ref(dbPath).set([]);
        }  

        // 2. Get unique key for the dataObject at the target path
        if (!dbKey) dbKey = fb.database().ref().child(dbPath).push().key;   // console.log("dbDataSubmit", dbKey, dbData); // return;

        //  3. Store&check the dataObject
        //  3.1 STORE
        fb.database().ref(dbPath+'/'+dbKey).set(dbData);  // console.log("save at:", dbPath+'/'+dbKey);
        
        //  3.2 CHECK
        var that = this;
        fb.database().ref(dbPath+'/'+dbKey).once('value').then(function(snapshot) { // console.log("data saved with key "+dbKey, snapshot.val());
            that.lastpath = dbPath+'/'+dbKey; 
        })

        // 3.3 reset the key !! to avoid save with altered data !!
        
        this.key = undefined; 
      }  

    });
  </script>

</dom-module>