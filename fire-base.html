<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../iron-localstorage/iron-localstorage.html">

<link rel="import" href="fire-base-lib.html">
<link rel="import" href="fire-base-conf.html">

<!--
`fire-base` is an element that manages connections to firebase.
It provides synchronization between client and server

@element fire-base
@demo demo/cloud-db.html
-->

<dom-module id="fire-base">

  <template>

    <style>
      :host {
        display: block;
      }
    </style>

    <!--<app-localstorage-element key="" >
    </app-localstorage-element>  -->

    <iron-localstorage
      name ="appstore"
      value="{{appstore}}">
      <!--on-iron-localstorage-load="_fbLoad">-->
      <!--on-iron-localstorage-load-empty="_fbInitialize">-->
    </iron-localstorage>

    <iron-ajax
        auto
        url       = "[[confurl]]"
        handle-as = "json"
        last-error   ="{{conferr}}"
        last-response="{{confdata}}">
    </iron-ajax>

  </template>

  <script>

    Polymer({
      is: 'fire-base',
      properties: {

        /**
         * IN: "FBConfigCollection" = collection of fb-app-configs
         * available for this app
         * (actually hard-wired in element "fire-base-conf.html")
         * @type {Object}
         */
        fbcc: {
          type: Object,
          observer: '_fbInitialize'
        },

        /**
         * IN: configuration of app
         * @type {String,Object}
         */
        fbconf: {
          value: "",
          observer: 'confCheck'
        },
        confurl: {
          value: ""
        },
        confdata: {
          value: "",
          observer: 'confDataGet'
        },
        conferr: {
          value: "",
          observer: 'confError'
        },
        /**
         * INP: key of firebase-project
         * (as configured in fb-console)
         * @type {String}
        */
        app: {
          type: String,
          notify: true
        },

        /**
         * OUT: instance of fb-connector
         * (fb.T : Config-object
         *  fb.C = this.app)
         * @type {Object}
         */
        fb: {
          type: Object,
          notify: true
        },

        /* fb activated within app*/
        appstore: {
          type: Object,
          value: {},
          observer: '_fbActivate'
        },

        authmode: {
          type: String,
          value:""
        },  // "anonym",

        email: {
          type:String,
          value:""
        },
        password: {
          type:String,
          value:""
        },

        user: {
           type: Object
        }

      },

      observers: [
        // '_getAuth(fb, authmode, email, password)'
      ],

      ready: function() { // console.log("firequery-ready");
        // this._fbInitialize();
      },

      confCheck: function(rawdata){ console.log("confCheck", rawdata, typeof rawdata);
        if (!rawdata) return;
        if (typeof rawdata == "string") {
          this.confurl = rawdata;
        } else if (typeof rawdata == "object") {
          this.confdata = rawdata;
        }
      },

      confDataGet: function(rawdata){ console.log("confDataRaw", rawdata);
        if (rawdata.access) {
          this.fbcc = rawdata.access;
        } else {
          this.fbcc = rawdata;
        }
      },

      confError: function(logdata){
        if (logdata) console.log("confError", logdata);
      },

      // activates a webApp-firebase-instance from localStorage
      _fbActivate : function(appstore) {
        var fbproject = this.app;
        if (!appstore) {
          this._fbInitialize();
        } else if (appstore && Object.keys(appstore).length) {
          this._fbRestore(appstore);
        }
        if (!this.fb) {
          console.log("_fbActivate failed for:", this.app);
          // this._fbInitialize();
        }
      },

      // restore from clients webstorage
      _fbRestore : function(appstore) {  console.log("appstore", appstore);
        if (appstore["access"]) {
            var storedfb = appstore["access"];
            if (!this.fb || (storedfb.name != this.fb.name)) {
              this.fb =  storedfb; console.log("Restored fbProject", this.fb);
            }
        };
      },


      /* initalizes webApp-firebase-instance(s)
         in a "multi-fb-env" */
      _fbInitialize : function(fbcc) {
        if (fbcc) { console.log("fbcc loaded:", fbcc);
          this.fbcc = fbcc;
        } else if (!this.fbcc) {
          console.log("ALERT. SETUP MISSING fb-configuration from DEMO", this.fbcc, "req", this.req);
          // this.fbcc = fbccTest;
          return;
        }

        if(!this.app) {
          var keys = Object.keys(this.fbcc); console.log(keys);
          this.app = keys[0];
        } console.log("initializing project:", this.app, this.fbcc);

        if (this.fb && (fb.name == this.app)) {
          console.log("ALERT!","fb2Initialize already exists: " + fb.name);
          fb.delete();
        }

        var fbc = this.fbcc[this.app]; // FireBaseConfig

        if (!fbc) {
          // this.fb = null;
          return;
        } console.log("_fbInitialize. fb=" + this.app, this.fb);

        // Initialize and Auth
        if (!this.fb || !Object.keys(this.fb).length) {
          var fb = firebase.initializeApp(fbc, this.app); console.log("_fb Initialized: " + fb.name);
          this._getAuth(fb);
        }
      },

      /* fb authorization (signin, signup)*/

      _getAuth: function(fb, authmode, email, password) {

        // 1. check current user
        var auth = fb.auth();
        if (auth.currentuser) { console.log("curent user=", auth.currentuser);
          this.user = auth.currentuser;
          return;
        }

        // 2. get authMode
        if (!authmode) {
          authmode = this.authmode;
        } else {
          if (!email)    email    = this.email;
          if (!password) password = this.password;
          if (email && password)  authmode=="email";
        }

        if (!authmode) authmode ="anonym";  // console.log("_getAuth for authmode, email, password", authmode, email, password);

        // 3. signIn
        var that = this;
        function signinOK(fb, user, msg) { // console.log(that);
          that.user = user;                 // F1: toggle-enable for additional gui-elements, fi.uploadbutton
          that.fb = fb;                     // F2: Activate this fb-access
          that.appstore = {"access" : fb}; // F3: Store into appstore
          console.log(msg+' SignIn Success for project:', that.appstore);
        }
        function signinError(error) {
          console.error('SignIn Error:', error);
          // that.user = null;
          // that.fb   = null;
        }

        if (authmode == "anonym") {
          // Sign the user in anonymously since accessing Storage requires the user to be authorized.
          auth.signInAnonymously()
              .then(function(user){
                signinOK(fb, user, 'Anonymous');
              })
              .catch(function(error) {
                signinError(error, that);
              });
        }

        if (authmode == "email") {
          authmode = "email";
          auth.signInWithEmailAndPassword(email, password)
              .then(function(user){
                signinOK(fb, user, 'Email');
              })
              .catch(function(error) {
                signinError(error);
              });
        }

        // Default: "popup for GoogleAccount"
        if (authmode == "popup") { // Default = "GoogleAuth"
          auth.signInWithPopup()
              .then(function(user){
                signinOK(fb, user, 'Popup');
              })
              .catch(function(error) {
                signinError(error);
              });
        }
      }

    });
  </script>
</dom-module>
