<!doctype html>
<html>
<head>
  <title>fire-base demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">

  <link rel="import" href="../../paper-tabs/paper-tabs.html">
  <link rel="import" href="../../paper-item/paper-item.html">
  <link rel="import" href="../../paper-listbox/paper-listbox.html">
  <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel="import" href="../../iron-image/iron-image.html">

  <link rel="import" href="../fire-query.html">

  <style is="custom-style" include="demo-pages-shared-styles">
  </style>
</head>

<body>

  <div>Demo of <span style="font-family: courier;">fire-query</span> - functionality</div>

  <dom-module id="cloud-query">

    <template>
    
      <style>
        :host {
          display: block;
          padding: 10px;
        }
        h1 {
          font-size: 22px;
          margin: 16px 0;
          color: #212121;
        }
        .small {
          font-size:10px;
        }
        .pre {
          font-style: italic;
        }
        .inp {
          width: 150px;
        }

        #chartab {
          width: 50%;
        }
      </style>

      <p>Query CloudMetadata objects by meta-properties using Firebase queries</p>

      <paper-dropdown-menu label="Query properties">
        <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{itemindex}}">
          <paper-item value="type-year">      year</paper-item>
          <paper-item value="type-character"> character</paper-item>
          <paper-item value="type-ice">       icetype</paper-item>
          <paper-item value="type-genus">     genus</paper-item>
          <paper-item value="type-photometeor">phototype</paper-item>
          <paper-item value="placeholder">    placeholder</paper-item>
          <paper-item value="type-*">         any type-classification</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>

      <hr/>
      
      <!-- QUERY blocks -->

      <template is='dom-if' if="{{isQueryItem(item, 'character')}}">
        <!-- Refine Query for objects with "character"-property 
             by preselected "character"-values or "wildcard-filters" -->
        <p>
          Select a "cloud-character" using name-input or from preselected values :  
          <paper-input class="inp" label="cloud character" value="{{charvalue}}"></paper-input>
        </p>

        <paper-tabs id="chartab" selected="{{charindex}}">
          <paper-tab>Heap</paper-tab>
          <paper-tab>Sheet</paper-tab>
          <paper-tab>Fleecy</paper-tab>
          <!-- <paper-tab>f*</paper-tab> -->
        </paper-tabs>

        <fire-query 
          app="wolke7" 
          path="cplocal" 
          item="[[item]]" 
          itemvalue="[[charvalue]]" 
          data="{{data}}">
        </fire-query>

        <p>[[querycount]] metaRecords of cloud-images with value <b>[[charvalue]]</b> of <b>form-character</b>-classification  <a href="https://www.rmets.org/weather-and-climate/observing/luke-howard-and-cloud-names" target="_blank">(Howard/1802)</a>.</p>
      
      </template>

      <template is='dom-if' if="{{isQueryItem(item, 'year')}}">
        <!-- Queries for YEAR-property refined with arbitrarily selected YEAR-values  -->

        <paper-input class="inp" label="select a year" value="{{year}}"></paper-input>

        <fire-query 
          app       = "wolke7" 
          path      = "cplocal" 
          item      = "[[item]]" 
          itemvalue = "[[year]]" 
          data      = "{{data}}"> 
        </fire-query>

        <p>[[querycount]] metaRecords of cloud-images for year(s) <b>[[year]]</b>. (The query is based on numerical year-values)</p>
      
      </template>

      <template is='dom-if' if="{{isQueryItem(item, 'not,year,character')}}">
        <!-- Generic Queries for objects which contain selected properties (any value) -->
        
        <fire-query 
          app       = "wolke7" 
          path      = "cplocal" 
          item      = "[[item]]" 
          itemvalue = "_all_" 
          data      = "{{data}}">
        </fire-query>
        
        <p>[[querycount]] metaRecords of cloud-images described with property: <b>[[item]]</b> </p>

      </template>    


      <!-- OOUTPUT-blocks --> 

      <!-- A. GENERIC view&process : 'dom-repeat' --> 
      
      <template is='dom-repeat' items='{{imas}}' as='img'>
        
        <!-- A.1 Show a row with cloud-properties at client-->
        <div>
          <span class="small">[[img.index]]</span>
          <span>[[img.title]]</span>
          <span class="pre">[[img.url]]</span>
          <span >[[iteminfo(img)]]</span>
        </div>

        <!-- A.2  Update/Save a single cloud-metaObject to fb-server -->
        <!-- <fire-query 
          app      ="wolke7" 
          path     ="cplocal" 
          key      ="[[img.fbkey]]" 
          keydata  ="[[img.item]]">
        </fire-query> -->  

      </template>

      <!-- B. Optional: SPECIFIC view-element using 'Promise.all' --> 
      
      <!-- <cloud-list></cloud-list>       -->

      <!-- C. GENERIC process-element(save) using 'Promise.all' -->
      
      <fire-query 
        app      ="wolke7" 
        path     ="cplocal" 
        savedata ="[[savedata]]"
        savectrl ="logged">
      </fire-query>  
    
    </template>

    <script>
    
      window.addEventListener('WebComponentsReady', function() {
        Polymer({

          is: 'cloud-query',
          
          properties: {
            
            fbapp : "",

            charindex : -1,  // = index of query-path-options

            // special case type-character
            charvalue: {
              type: String,
              computed: 'getCharValue(charindex)'
            },

            path:  {
              type: String
            },

            items:{
              type: Array,
              observer: 'useItems'
            },

            values:{
              type: Array,
              observer: 'useValues'
            },

            itemindex: {
              type: String,
              observer: 'getitem'
            }, 

            item: {
              type: String
            }, 
            
            // special case type-character
            itemvalue: {
              type: String,
              computed: 'getValue(itemindex)'
            },

            data: {
              type: Object,
              value: [] 
            },

            imas: {
              type: Object,
              computed: 'imaMetaLoad(data)'
            },

            savedata: {
              type: Object,
              computed: 'imaMetaSave(imas)'
            },

          },

          observers : [
          ], 

          ready: function(){
            this.charindex = 0;    // triggers view of FIRST Query-set
            this.item       = "type-character";
            // this.itemvalue = 'none';
            // this.item      = "type-year";
            // this.itemvalue = 2002;
          },

          // presentation util
          iteminfo: function(item) {
            if (!item.name) return "";
            var info = "|| " + item.name;
            if (item.value && (item.value.length < 20)) info = info+" : "+ item.value;
            return info;
          },

          /**
           * Change queryItem
           * @param  {String} n Name of query-property
          */
          getitem: function(n){ 
            this.charvalue  = "_all_";
            this.charindex  = -1;
            this.querycount = "";
            this.item = n;
          },

          useItems: function(n,o) {   console.log("query items:", n);
          },

          useValues: function(n,o) {  console.log("query values:", n);
          },

          // 
          getCharValue: function(index) { console.log("charValueLOG:", index, this.item);
            var items = {0:"heap", 1:"sheet", 2:"fleecy"};
            value = items[index];
            return value;
          },
          // 
          getValue: function(index) { console.log("getValueLOG:", index, this.item);
            var value = "_all_"; 
            return value;
          },

          // 
          imaMetaLoad: function(data) { console.log("raw data", data); // , itemname, itemvalue) { 
          
            this.querycount = "";
            if (!data) return;

            var itemname  = this.item; // as used for query !!

            if (!Array.isArray(data)) {
              var keys = Object.keys(data), obj;
              data  = keys.map(function(k){ 
                obj = {};
                obj.item  = data[k];        
                obj.fbkey = k;
                return obj;
              }); 
            }; // console.log("cloudDataArray:", data); 

            // Prepare a standard-array (url, item) for "slide-show"
            var ima , title, index, nn = data.length, imas = [];

            data.forEach( function(ima,index){  // console.log(index, item);
              
              item  = ima.item; 
              index = "("+ (index+1) +"/" + nn +") ";
              title = item["title-main-pict"] ;
              if (item["title-sub-pict"]) title = title+" / "+item["title-sub-pict"] ;
              
              ima.url   = item.url;
              ima.title = title;
              ima.index = index;
              
              if (itemname) { // as used for FDB-query 
                ima.name = itemname;
                if (item[itemname]) ima.value=item[itemname]; // as queried from FDB
              }  
              imas.push(ima)
            }); 
            
            this.querycount = imas.length;  console.log("imageArray.length="+this.querycount); 
            //****************************
            return imas; 
          },

          imaMetaSave: function(imas) { // console.log("imaMetaSave", imas);
            if (!imas) return; 
            var data, dataset = {}, d = new Date(); // console.log("exporting-1", d, imas) 
            imas.forEach( function(ima,index){  // cons
              var log =          d.getDate()  
                        + "-" + (d.getMonth()+1) 
                        + "-" + d.getFullYear() 
                        + " " + d.getHours() 
                        + ":" + d.getMinutes();
              //data = ima.item;
              //data.log = log;
              data = {"logged":log};
              dataset[ima.fbkey] = data;
            }); console.log("imaMetaSave-2", dataset);
            return dataset;
          }, 
          
          isQueryItem: function(queryitem, key) {  
            var keys = key.split(","),
                key  = keys[0];  console.log(queryitem, key, keys);

            if (queryitem.indexOf(key) >= 0) return true;

            if (key == "not") {
              var flag=true; 
              keys.every(function(k){
                if (queryitem.indexOf(k) >= 0) {
                  flag = false;
                  return false;
                }  
              })
              return flag; 
            } 
            return false; 
          }

        });
      });   
    </script>

  </dom-module>

  <cloud-query></cloud-query>

</body>
</html>
