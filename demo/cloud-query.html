<!doctype html>
<html>
<head>
  <title>fire-base demo</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1, user-scalable=yes">
  <script src="../../webcomponentsjs/webcomponents-lite.js"></script>

  <link rel="import" href="../../iron-demo-helpers/demo-pages-shared-styles.html">
  <link rel="import" href="../../iron-demo-helpers/demo-snippet.html">

  <link rel="import" href="../../paper-tabs/paper-tabs.html">
  <link rel="import" href="../../paper-item/paper-item.html">
  <link rel="import" href="../../paper-listbox/paper-listbox.html">
  <link rel="import" href="../../paper-dropdown-menu/paper-dropdown-menu.html">
  <link rel="import" href="../../iron-image/iron-image.html">

  <link rel="import" href="../fire-query.html">

  <style is="custom-style" include="demo-pages-shared-styles">
  </style>
</head>

<body>

  <div>Demo of <span style="font-family: courier;">fire-query</span></div>

  <dom-module id="cloud-types">

    <template>
    
      <style>
        :host {
          display: block;
          padding: 10px;
        }
        h1 {
          font-size: 22px;
          margin: 16px 0;
          color: #212121;
        }
        .small {
          font-size:10px;
        }
        .pre {
          font-style: italic;
        }
      </style>

      <p>Selecting CloudImgMeta by Firebase queries</p>

      <paper-dropdown-menu label="Query properties">
        <paper-listbox class="dropdown-content" attr-for-selected="value" selected="{{itemindex}}">
          <paper-item value="type-year">year</paper-item>
          <paper-item value="type-character">character</paper-item>
          <paper-item value="type-ice">icetype</paper-item>
          <paper-item value="type-genus">genus</paper-item>
          <paper-item value="type-photometeor">phototype</paper-item>
          <paper-item value="placeholder">placeholder</paper-item>
          <paper-item value="type-*">any type-classification</paper-item>
        </paper-listbox>
      </paper-dropdown-menu>

      <hr/>
      
      <template is='dom-if' if="{{isQueried(item, 'character')}}">

        <p>Select a "type-character" value</p>
        <paper-tabs selected="{{valueindex}}">
          <paper-tab>Heap</paper-tab>
          <paper-tab>Sheet</paper-tab>
          <paper-tab>Fleecy</paper-tab>
          <paper-tab>f*</paper-tab>
        </paper-tabs>

        <fire-query app="wolke7" path="cplocal" item="[[item]]" itemvalue="[[itemvalue]]" data="{{data}}"></fire-query>

        <p>[[querycount]] ImageMeta of clouds with value <b>[[itemvalue]]</b> of classification <b>form-character</b> <a href="https://www.rmets.org/weather-and-climate/observing/luke-howard-and-cloud-names" target="_blank">(Howard/1802)</a>.</p>
      
      </template>


      <template is='dom-if' if="{{isQueried(item, 'year')}}">

        <paper-input label="select a year" value="{{itemvalue}}"></paper-input>

        <fire-query app="wolke7" path="cplocal" item="[[item]]" itemvalue="[[itemvalue]]" data="{{data}}"></fire-query>

        <p>[[querycount]] ImageMeta of clouds for year(s) <b>[[itemvalue]]</b>: Query numerical year-values</p>
      
      </template>


      <template is='dom-if' if="{{isQueried(item, 'not,year,character')}}">
        
        <fire-query app="wolke7" path="cplocal" item="[[item]]" itemvalue="_all_" data="{{data}}"></fire-query>
        
        <p>[[querycount]] CloudImageMeta queried by: <b>[[item]]</b> </p>

      </template>    

      
      <!-- COMMON Result-block --> 

      <template is='dom-repeat' items='{{imas}}' as='img'>
        <div>
          <span class="small">[[img.index]]</span>
          <span>[[img.title]]</span>
          <span class="pre">[[img.url]]</span>
          <span >[[iteminfo(img)]]</span>
        </div>
      </template>

    </template>

    <script>
    
      window.addEventListener('WebComponentsReady', function() {
        Polymer({

          is: 'cloud-types',
          
          properties: {
            
            fbapp : "",

            valueindex : -1,  // = index of query-path-options

            path:  {
              type: String
            },

            items:{
              type: Array,
              observer: 'useItems'
            },

            values:{
              type: Array,
              observer: 'useValues'
            },

            itemindex: {
              type: String,
              observer: 'getitem'
            }, 

            item: {
              type: String
            }, 
            
            // special case type-character
            itemvalue: {
              type: String,
              computed: 'getValue(valueindex)'
            },

            data: {
              type: Object,
              value: [] 
            },

            imas: {
              type: Object,
              computed: 'createSlides(data)'
            }
          },

          observers : [
            // 'calcTarget(fbapp, path)'
          ], 

          ready: function(){
            this.valueindex = 0;    // triggers view of FIRST Query-set
            this.item       = "type-character";
            // this.itemvalue = 'none';
            // this.item      = "type-year";
            // this.itemvalue = 2002;
          },

          // presentation util
          iteminfo: function(item) {
            if (!item.item) return "";
            var info = "|| " + item.item;
            if (item.value && (item.value.length < 20)) info = info+" : "+ item.value;
            return info;
          },

          /**
           * Change queryItem
           * @param  {String} n Name of query-property
          */
          getitem: function(n){ 
            this.itemvalue = "_all_";
            this.valueindex = -1;
            this.querycount = "";
            this.item = n;
          },

          useItems: function(n,o) { console.log("query items:", n);
          },

          useValues: function(n,o) {  console.log("query values:", n);
          },

          // 
          getValue: function(index) { console.log("calValueLOG:", index, this.item);
            var value = "_all_"; 
            if (this.item == "type-character") {
              var items = {0:"heap", 1:"sheet", 2:"fleecy", 3:"f*"};
              value = items[index];
            } 
            return value;
          },

          // 
          createSlides: function(data) { // , itemname, itemvalue) { 
            if (!data) return;
            var itemname  = this.item; // as used for query !!

            if (!Array.isArray(data)) {
              data =  Object.keys(data)
                      .map(function(k){
                        return data[k]}
                      );
            } // console.log("cloudDataArray:", data); 

            // Prepare a standard-array (url, item) for "slide-show"
            var ima , title, index, nn = data.length, imas = [];
            data.forEach(function(item,index){  // console.log(index, item);
              index = "("+ (index+1) +"/" + nn +") ";
              title = item["title-main-pict"] ;
              if (item["title-sub-pict"]) title = title+" / "+item["title-sub-pict"] ;
              ima = {
                url: item.url,
                title: title,
                index: index,
                item: itemname
              }
              if (itemname) { // as used for FDB-query 
                ima.item=itemname;
                if (item[itemname]) ima.value=item[itemname]; // as queried from FDB
              }  

              imas.push(ima)
            }); 
            this.querycount = imas.length; console.log("cloudArray. length="+this.querycount); 
            return imas; 
          },

          isQueried: function(queryitem, key) { // 
            var keys = key.split(","),
                key  = keys[0];
            if (queryitem.indexOf(key) >= 0) return true;

            if (key == "not") {
              var flag=true; 
              keys.every(function(k){
                if (queryitem.indexOf(k) >= 0) {
                  flag = false;
                  return false;
                }  
              })
              return flag; 
            } 
            return false; 
          }

        });
      });   
    </script>

  </dom-module>

  <cloud-types></cloud-types>

</body>
</html>
